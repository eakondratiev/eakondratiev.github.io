<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>File Signature</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="apple-mobile-web-app-title" content="File Signature" />
    <meta name="application-name" content="File Signature" />

    <meta property="og:title" content="File Signature">
    <meta name="description" content="This online utility app will show a file signature.">
    <meta property="og:description" content="This online utility app will show a file signature.">
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eakondratiev.github.io/file-signature.htm">
    <link rel="canonical" href="https://eakondratiev.github.io/file-signature.htm">

    <meta name="msapplication-config" content="/assets/icons/browserconfig.xml" />
    <meta name="theme-color" content="#444444" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon-180.png" />
    <link rel="manifest" href="/assets/icons/manifest.json" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-16.png" sizes="16x16" />
  
    <link href="/assets/main.css?20220622" rel="stylesheet" type="text/css" />
    <script src="/assets/menu.min.js?20220730"></script>
    <script src="/assets/web-app.js"></script>
    <style>
      .file-signature {font-size:0.9rem; margin: 16pt 0; color:#333;}
      .file-prop {display: flex; margin: 8pt;}
      .file-prop-name {width: 75pt;}
      .file-prop-value {font-style: italic; max-width: 250pt; text-overflow: ellipsis;}
      .list-all {font-size:0.9rem;}
    </style>
  <body>
    <div class="main-content">
      <div class="page-wide header">
        <header class="content">
          <button class="site-menu-btn" aria-label="Open the site menu">
            <div></div>
            <div></div>
            <div></div>
          </button>
          <div class="site-title"><a class="site-logo" href="/">TOOL</a></div>
        </header>
        <nav class="content site-nav" aria-label="Site menu">
          <h3 class="site-nav-header">Online Tools</h3>
          <ul>
          <li class="site-nav-top-item"><a href="regex.htm">Regex Tester</a></li>
          <li class="site-nav-top-item"><a href="roman-numerals.htm">Convert a Roman Number</a></li>
          <li class="site-nav-top-item"><a href="iprange.htm">IPv4 Ranges</a></li>
          <li class="site-nav-top-item"><a href="speed.htm">Speed &amp; Distance</a></li>
          <li class="site-nav-top-item"><a href="ws.htm">White Spaces</a></li>
          <li class="site-nav-top-item"><a href="floating-point-representation.htm">Representation of Floating-point Numbers 32 and 64 bits</a></li>
          <li class="site-nav-top-item"><a href="floating-point-summation.htm">Floating-point Summation</a></li>
          </ul>
          <h3 class="site-nav-header">Console Tools</h3>
          <ul>
            <li class="site-nav-top-item"><a href="crd-reader.htm">CRD Reader</a></li>
          </ul>
        </nav>
      </div>
      <div class="page-wide">
        <div class="content page-content">
          <noscript><div>This site uses javascript. Please, turn it on in your browser settings.</div></noscript>
          <div id="incompatible-browser">Please, update your browser.</div>
          <h1>File Signature</h1>
          <p>This online utility app shows a file signature.</p>

          <div class="fp-form">
            <input type="file" id="input-file" accesskey="F" placeholder="Select a file" value="" aria-label="Select a file">
            <button type="button" id="btn-show" accesskey="S"><u>S</u>how</button>
          </div>

          <div class="file-signature"></div>
          <div class="list-all"></div>

          <p style="font-size:0.8rem;">
            Source: <a href="https://en.wikipedia.org/wiki/List_of_file_signatures" target="_blank" rel="noreferrer">List of file signatures, WIkipedia.org</a>
          </p>
          <div class="page-tags">
            <b>#Tool</b>
          </div>
        </div>
      </div>
    </div>
    <div class="page-wide footer">
      imperfect <b>tools</b>
    </div>
    <script>
      'use strict';

      var _ToolNoLogs = true; // TODO: remove on prod

      /** Definitions */
      var SIGNATURES = {
        'OracleVMDisk': {description: 'VirtualBox Virtual Hard Disk'},
        'PuTTY-key2': {description: 'PuTTY private key file version 2'},
        'PuTTY-key3': {description: 'PuTTY private key file version 3'},
        'pem-crt': {description: 'PEM encoded X.509 certificate'},
        'pem-csr': {description: 'PEM encoded X.509 Certificate Signing Request'},
        'pem-key': {description: 'PEM encoded X.509 PKCS#8 private key'},
        'pem-DSAkey': {description: 'PEM encoded X.509 PKCS#1 DSA private key'},
        'pem-RSAkey': {description: 'PEM encoded X.509 PKCS#1 RSA private key'},
        'AppleWorks5': {description: 'AppleWorks 5 document'},
        'AppleWorks6': {description: 'AppleWorks 6 document'},
        'EPS3.0': {description: 'Encapsulated PostScript file version 3.0'},
        'EPS3.1': {description: 'Encapsulated PostScript file version 3.1'},
        'SQLite3': {description: 'SQLite Database'},
        'ASF-WMA-WMV': {description: 'asf, wma, wmv - Advanced Systems Format'},
        'DJVU': {description: 'DjVu document'},
        'AIFF': {description: 'AIFF, Audio Interchange File Format'},
        'wav':  {description: 'wav, Waveform Audio File Format'},
        'avi':  {description: 'avi, Audio Video Interleave video format'},
        'webp': {description: 'Google WebP image file'},
        'ani':  {description: 'Animated cursor'},
        'dcr':  {description: 'Adobe Shockwave file'},
        'dir':  {description: 'Macromedia Director file'},
        'JPEG': {description: 'JPEG raw or in the JFIF or Exif'},
        'JPEG2000': {description: 'JPEG 2000 file'},
        'WinHtmlHelp': {description: 'chm, Microsoft Windows HtmlHelp file'},
        'CanonRAW': {description: 'Canon RAW Format Version 2'},
        'vhd':  {description: 'Windows Virtual PC Virtual Hard Disk'},
        'vhdx': {description: 'Windows Virtual PC Windows 8 Virtual Hard Disk file'},
        'evtx': {description: 'Windows Event Viewer XML file'},
        'TAR': {description: 'tar archive'},
        'deb': {description: 'Linux deb file'},
        'mp4': {description: 'ISO Base Media file (MPEG-4)'},
        'OfficeOld': {description: 'Compound File Binary Format, a container format defined by Microsoft COM.' +
                  ' It can contain the equivalent of files and directories.' +
                  ' It is used by <b>Windows Installer</b> and for documents in <b>older versions of Microsoft Office</b>.'},
        'MS-SDI': {description: 'SDI, System Deployment Image, a disk image format used by Microsoft'},
        'PNG': {description: 'png, Image encoded in the Portable Network Graphics format'},
        'RAR1.5': {description: 'rar, Roshal ARchive compressed archive v1.50 onwards'},
        'RAR5':   {description: 'rar, Roshal ARchive compressed archive v5.00 onwards'},
        'WinUpdDelta': {description: 'Windows Update Binary Delta Compression file'},
        'xcf': {description: 'XCF file, GIMP native'},
        'GIF87a': {description: 'gif, Image file encoded in the Graphics Interchange Format (GIF87a)'},
        'GIF89a': {description: 'gif, Image file encoded in the Graphics Interchange Format (GIF89a)'},
        '7z': {description: '7-Zip File Format'},
        'xz': {description: 'xz, tar.xz - XZ compressed file, LZMA2 compression'},
        'ftyp3g': {description: '3rd Generation Partnership Project 3GPP and 3GPP2 multimedia files'},
        'PDF': {description: 'PDF document'},
        'iso-sdi': {description: 'cdi, CD-i CD image file'},
        'ttf': {description: 'TrueType font'},
        'ico': {description: 'Computer icon encoded in ICO file format'},
        'elf': {description: 'Executable and Linkable Format'},
        'OGGS': {description: 'Ogg, an open source media container format'},
        'PSD': {description: 'Adobe Photoshop\'s native file'},
        'Mach-O32': {description: 'Mach-O binary, 32-bit'},
        'Mach-O64': {description: 'Mach-O binary, 64-bit'},
        'Mach-O32rev': {description: 'Mach-O binary, reverse byte ordering scheme, 32-bit'},
        'Mach-O64rev': {description: 'Mach-O binary, reverse byte ordering scheme, 64-bit'},
        'ZIP': {description: 'zip file format and formats based on it, such as EPUB, JAR, ODF, OOXML'},
        'LZIP': {description: 'lzip compressed file'},
        'LZ4': {description: ' 	LZ4 compressed file'},

      };

      // check for compatibility
      if (document.getElementsByClassName === undefined ||
         window.fetch === undefined ||
         typeof WebAssembly !== "object" ||
         typeof WebAssembly.instantiate !== "function" ||
         !Element.prototype.addEventListener ||
         !Array.prototype.map ||
         !Array.prototype.reduce) {

        document.getElementById('incompatible-browser').style.display = 'block';

      }
      else {

        var fileElement = document.getElementById ('input-file');
        var resultElement = document.getElementsByClassName('file-signature')[0];
        var calcBtn = document.getElementById('btn-show');

        var listAll = document.getElementsByClassName('list-all')[0].innerHTML = listAllDescriptions(SIGNATURES);

        calcBtn.addEventListener('click', function () {
          showFileProperties(fileElement, resultElement);
        });

        fileElement.addEventListener('keypress', function(e) { 
          if (e.key === 'Enter') {
            showFileProperties(fileElement, resultElement);
          }
        });

        fileElement.addEventListener('change', function(e) {
          showFileProperties(fileElement, resultElement);
        });
      }

      /**
       * Appends the file properties to the result element.
       * @param {*} fileElement
       * @param {*} resultElement
       */
      function showFileProperties(fileElement, resultElement) {

        var r = '';
        var file;
        var reader = new FileReader();

        if (fileElement.files === undefined ||
            fileElement.files.length === 0) {

          r = 'SELECT A FILE!';
        }
        else {
          file = fileElement.files[0];

          r =
            getResultProperty ('File name', file.name) +
            getResultProperty ('File MIME type', file.type) +
            getResultProperty ('File size', formatFileSize (file.size));

          reader.readAsArrayBuffer (file);

          reader.onload = function (e) {
            getSignatue (e.target.result, resultElement);
          };

          reader.onerror = function (e) {
            console.log ('Read error', e.type);
          }

        }

        resultElement.innerHTML = r;
      }

      /**
       * Processes the file bytes and appends the file description to the result element.
       * @param {*} fileData
       * @param {*} resultElement
       */
      function getSignatue(fileData, resultElement) {

        // https://wasdk.github.io/WasmFiddle/
        // move -Force C:\Users\ekond\Downloads\program.wasm D:\MyStuff\EA\eakondratiev.github.io\assets\filesignature.wasm

        const params = {
            env: {
                memory_base: 0,
                table_base: 0,
                memory : new WebAssembly.Memory({ initial: 256}),
                table: new WebAssembly.Table({
                    initial: 0,
                    element: 'anyfunc',
                })
            }          
          };

        fetch('/assets/filesignature.wasm')
          .then(response =>
            response.arrayBuffer()
          )
          .then(bytes => WebAssembly.instantiate(bytes, params))
          .then(results => {

            var instance = results.instance;

            const { memory, getFileSignature } = instance.exports;

            // create input and output arrays
            let allZeroes = a => {
              for (let i = 0; i < a.length; i++) {a[i] = 0;}
            };

            // input
            const FILE_ARRAY_SIZE = 300; // some signatures uses an offset
            const RESULT_ARRAY_SIZE = 45;
            let offset = 0;

            const fileBytes = new Uint8Array(memory.buffer, offset, FILE_ARRAY_SIZE);
            allZeroes (fileBytes);
            fileBytes.set(new Uint8Array (fileData, 0, Math.min (fileData.byteLength, FILE_ARRAY_SIZE)));

            // result
            offset += FILE_ARRAY_SIZE * Uint8Array.BYTES_PER_ELEMENT;
            const resultBytes = new Uint8Array(memory.buffer, offset, RESULT_ARRAY_SIZE);
            allZeroes (resultBytes);

            var r = getFileSignature (fileBytes.byteOffset, resultBytes.byteOffset);

            resultElement.innerHTML += getResultProperty ('Description', getDescription (getStringFromBuffer(resultBytes)));

            console.log ('RES', {fileBytes, resultBytes});

            
          })
          .catch(err => {
            resultElement.innerHTML += ' * ERR: ' + err.toString();
            console.log(err);
            }
          );

      }

      /**
       * Returns html formatted file property.
       * @param {string} name
       * @param {string} value
       * @param {string} unit
       */
      function getResultProperty(name, value) {

        return '<div class="file-prop">' +
            '<span class="file-prop-name">' + name + '</span>' +
            '<span class="file-prop-value">' + value + '</span>' +
            '</div>';
      }

      /**
       * Returns string with the file size.
       * @param {number} size
       */
      function formatFileSize(size) {

        var FMT = {minimumFractionDigits: 0, maximumFractionDigits: 1};
        var KB = 1024;       // 2^10
        var MB = 1048576;    // 2^20
        var GB = 1073741824; // 2^30
        var t = '';

        if (size >= GB) {
          t = T.formatNumber(size/GB, 'en-US', FMT) + ' KB, ';
        }
        else if (size >= MB) {
          t = T.formatNumber(size/MB, 'en-US', FMT) + ' KB, ';
        }
        else if (size >= KB) {
          t = T.formatNumber(size/KB, 'en-US', FMT) + ' KB, ';
        }

        t += size + ' byte(s)';

        return t;
      }

      /**
       * Returns the string from the buffer array.
       * @param buf
       */
      function getStringFromBuffer (buf) {
        let s = "";
        let index = 0;
        while(true){
            if(buf[index] !== 0){
                s += String.fromCharCode(buf[index]);
                index++;
            }else{
                return s;
            }
        }

        return '';
      }

      /**
       * Returns the file description by the key.
       * @param {string} key
       */
      function getDescription(key) {

        if (key === '') {
          return 'signature not found';
        }

        if (SIGNATURES[key] === undefined) {
          return 'unknown signature ' + key;
        }

        return SIGNATURES[key].description;
      }

      /**
       * Returns the html list of all supported file descriptions.
       * @param list
       */
      function listAllDescriptions(list) {
        
        var keys = Object.keys (list);
        var i;
        var html = '';

        for (i = 0; i < keys.length; i++) {
          html += '<li>' + list[keys[i]].description + '</li>';
        }

        return '<p>Formats supported: <b>' + keys.length + '</b></p>' +
          '<ul>' + html + '</ul>';
      }
    </script>
  </body>
</html>