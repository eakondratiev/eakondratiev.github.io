<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>File Signature</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="apple-mobile-web-app-title" content="File Signature" />
    <meta name="application-name" content="File Signature" />

    <meta property="og:title" content="File Signature">
    <meta name="description" content="This online utility app will show a file signature.">
    <meta property="og:description" content="This online utility app will show a file signature.">
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eakondratiev.github.io/file-signature.htm">
    <link rel="canonical" href="https://eakondratiev.github.io/file-signature.htm">

    <meta name="msapplication-config" content="/assets/icons/browserconfig.xml" />
    <meta name="theme-color" content="#444444" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon-180.png" />
    <link rel="manifest" href="/assets/icons/manifest.json" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-16.png" sizes="16x16" />
  
    <link href="/assets/main.css?20220622" rel="stylesheet" type="text/css" />
    <script src="/assets/menu.min.js?20220730"></script>
    <script src="/assets/web-app.js"></script>
    <style>
      .file-signature {font-size:0.8rem; margin: 16pt 0; color:#333;}
      .file-prop {
        font-style: italic; max-width: 250pt; text-overflow: ellipsis; color: #000;
      }
    </style>
  <body>
    <div class="main-content">
      <div class="page-wide header">
        <header class="content">
          <button class="site-menu-btn" aria-label="Open the site menu">
            <div></div>
            <div></div>
            <div></div>
          </button>
          <div class="site-title"><a class="site-logo" href="/">TOOL</a></div>
        </header>
        <nav class="content site-nav" aria-label="Site menu">
          <h3 class="site-nav-header">Online Tools</h3>
          <ul>
          <li class="site-nav-top-item"><a href="regex.htm">Regex Tester</a></li>
          <li class="site-nav-top-item"><a href="roman-numerals.htm">Convert a Roman Number</a></li>
          <li class="site-nav-top-item"><a href="iprange.htm">IPv4 Ranges</a></li>
          <li class="site-nav-top-item"><a href="speed.htm">Speed &amp; Distance</a></li>
          <li class="site-nav-top-item"><a href="ws.htm">White Spaces</a></li>
          <li class="site-nav-top-item"><a href="floating-point-representation.htm">Representation of Floating-point Numbers 32 and 64 bits</a></li>
          <li class="site-nav-top-item"><a href="floating-point-summation.htm">Floating-point Summation</a></li>
          </ul>
          <h3 class="site-nav-header">Console Tools</h3>
          <ul>
            <li class="site-nav-top-item"><a href="crd-reader.htm">CRD Reader</a></li>
          </ul>
        </nav>
      </div>
      <div class="page-wide">
        <div class="content page-content">
          <noscript><div>This site uses javascript. Please, turn it on in your browser settings.</div></noscript>
          <div id="incompatible-browser">Please, update your browser.</div>
          <h1>File Signature</h1>
          <p>This online utility app shows a file signature.</p>

          <div class="fp-form">
            <input type="file" id="input-file" accesskey="F" placeholder="Select a file" value="" aria-label="Select a file">
            <button type="button" id="btn-show" accesskey="S"><u>S</u>how</button>
          </div>

          <div class="file-signature"></div>

          <div class="page-tags">
            <b>#Tool</b>
          </div>
        </div>
      </div>
    </div>
    <div class="page-wide footer">
      imperfect <b>tools</b>
    </div>
    <script>
      'use strict';

      var _ToolNoLogs = true; // TODO: remove on prod

      // check for compatibility
      if (document.getElementsByClassName === undefined ||
         window.fetch === undefined ||
         typeof WebAssembly !== "object" ||
         typeof WebAssembly.instantiate !== "function" ||
         !Element.prototype.addEventListener ||
         !Array.prototype.map ||
         !Array.prototype.reduce) {

        document.getElementById('incompatible-browser').style.display = 'block';

      }
      else {

        var fileElement = document.getElementById ('input-file');
        var resultElement = document.getElementsByClassName('file-signature')[0];
        var calcBtn = document.getElementById('btn-show');

        calcBtn.addEventListener('click', function () {
          showSignature(fileElement, resultElement);
        });

        fileElement.addEventListener('keypress', function(e) { 
          if (e.key === 'Enter') {
            showSignature(fileElement, resultElement);
          }
        });
      }

      function showSignature(fileElement, resultElement) {

        var r = '';
        var file;
        var reader = new FileReader();

        if (fileElement.files === undefined ||
            fileElement.files.length === 0) {

          r = 'SELECT A FILE!';
        }
        else {
          file = fileElement.files[0];
          r =
            '<div>File name: <span class="file-prop">' + file.name + '</span></div>' +
            '<div>File type: <span class="file-prop">' + file.type + '</span></div>' +
            '<div>File size: <span class="file-prop">' + file.size + '</span> byte(s)</div>';

          reader.onload = function (e) {
            getSignatue (e.target.result, resultElement);
            resultElement.innerHTML += ' * Read';
            console.log ('Read', e.target.result);
          };

          reader.onerror = function (e) {
            console.log ('Read error', e.type);
          }

          reader.readAsArrayBuffer (file);
        }

        resultElement.innerHTML = r;
      }

      function getSignatue(fileData, resultElement) {

        // https://wasdk.github.io/WasmFiddle/
        // move -Force C:\Users\ekond\Downloads\program.wasm D:\MyStuff\EA\eakondratiev.github.io\assets\filesignature.wasm

        const params = {
            env: {
                memory_base: 0,
                table_base: 0,
                memory : new WebAssembly.Memory({ initial: 256}),
                table: new WebAssembly.Table({
                    initial: 0,
                    element: 'anyfunc',
                })
            }          
          };

        fetch('/assets/filesignature.wasm')
          .then(response =>
            response.arrayBuffer()
          )
          .then(bytes => WebAssembly.instantiate(bytes, params))
          .then(results => {

            var instance = results.instance;

            const { memory, getFileSignature } = instance.exports;
            const mem = new Uint8Array(memory.buffer, 0);

            var r = getFileSignature (fileData, mem.byteOffset);
            resultElement.innerHTML += ' * WASM? R=' + r.toString() +
              ' OUTPUT: ' + getStringFromBuffer(mem);
            //console.log ('RES', mem);

          })
          .catch(err => {
            resultElement.innerHTML += ' * ERR: ' + err.toString();
            console.log(err);
            }
          );

      }

      function getStringFromBuffer (buf) {
        let s = "";
        let index = 0;
        while(true){
            if(buf[index] !== 0){
                s += String.fromCharCode(buf[index]);
                index++;
            }else{
                return s;
            }
        }

        return '';
      }
    </script>
  </body>
</html>