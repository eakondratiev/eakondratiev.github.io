<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>File Signature</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="apple-mobile-web-app-title" content="File Signature" />
    <meta name="application-name" content="File Signature" />

    <meta property="og:title" content="File Signature">
    <meta name="description" content="This online utility app will show a file signature.">
    <meta property="og:description" content="This online utility app will show a file signature.">
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eakondratiev.github.io/file-signature.htm">
    <link rel="canonical" href="https://eakondratiev.github.io/file-signature.htm">

    <meta name="msapplication-config" content="/assets/icons/browserconfig.xml" />
    <meta name="theme-color" content="#444444" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon-180.png" />
    <link rel="manifest" href="/assets/icons/manifest.json" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/assets/icons/favicon-16.png" sizes="16x16" />
  
    <link href="/assets/main.css?20220622" rel="stylesheet" type="text/css" />
    <script src="/assets/menu.min.js?20220730"></script>
    <script src="/assets/web-app.js"></script>
    <style>
      .file-signature {font-size:0.8rem; margin: 16pt 0; color:#333;}
      .file-prop {display: flex;}
      .file-prop-name {width: 75pt;}
      .file-prop-value {
        font-style: italic; max-width: 250pt; text-overflow: ellipsis;}
    </style>
  <body>
    <div class="main-content">
      <div class="page-wide header">
        <header class="content">
          <button class="site-menu-btn" aria-label="Open the site menu">
            <div></div>
            <div></div>
            <div></div>
          </button>
          <div class="site-title"><a class="site-logo" href="/">TOOL</a></div>
        </header>
        <nav class="content site-nav" aria-label="Site menu">
          <h3 class="site-nav-header">Online Tools</h3>
          <ul>
          <li class="site-nav-top-item"><a href="regex.htm">Regex Tester</a></li>
          <li class="site-nav-top-item"><a href="roman-numerals.htm">Convert a Roman Number</a></li>
          <li class="site-nav-top-item"><a href="iprange.htm">IPv4 Ranges</a></li>
          <li class="site-nav-top-item"><a href="speed.htm">Speed &amp; Distance</a></li>
          <li class="site-nav-top-item"><a href="ws.htm">White Spaces</a></li>
          <li class="site-nav-top-item"><a href="floating-point-representation.htm">Representation of Floating-point Numbers 32 and 64 bits</a></li>
          <li class="site-nav-top-item"><a href="floating-point-summation.htm">Floating-point Summation</a></li>
          </ul>
          <h3 class="site-nav-header">Console Tools</h3>
          <ul>
            <li class="site-nav-top-item"><a href="crd-reader.htm">CRD Reader</a></li>
          </ul>
        </nav>
      </div>
      <div class="page-wide">
        <div class="content page-content">
          <noscript><div>This site uses javascript. Please, turn it on in your browser settings.</div></noscript>
          <div id="incompatible-browser">Please, update your browser.</div>
          <h1>File Signature</h1>
          <p>This online utility app shows a file signature.</p>

          <div class="fp-form">
            <input type="file" id="input-file" accesskey="F" placeholder="Select a file" value="" aria-label="Select a file">
            <button type="button" id="btn-show" accesskey="S"><u>S</u>how</button>
          </div>

          <div class="file-signature"></div>

          <p style="font-size:0.8;">
            Source: <a href="https://en.wikipedia.org/wiki/List_of_file_signatures" target="_blank" rel="noreferrer">List of file signatures, WIkipedia.org</a>
          </p>
          <div class="page-tags">
            <b>#Tool</b>
          </div>
        </div>
      </div>
    </div>
    <div class="page-wide footer">
      imperfect <b>tools</b>
    </div>
    <script>
      'use strict';

      var _ToolNoLogs = true; // TODO: remove on prod

      // check for compatibility
      if (document.getElementsByClassName === undefined ||
         window.fetch === undefined ||
         typeof WebAssembly !== "object" ||
         typeof WebAssembly.instantiate !== "function" ||
         !Element.prototype.addEventListener ||
         !Array.prototype.map ||
         !Array.prototype.reduce) {

        document.getElementById('incompatible-browser').style.display = 'block';

      }
      else {

        var fileElement = document.getElementById ('input-file');
        var resultElement = document.getElementsByClassName('file-signature')[0];
        var calcBtn = document.getElementById('btn-show');

        calcBtn.addEventListener('click', function () {
          showSignature(fileElement, resultElement);
        });

        fileElement.addEventListener('keypress', function(e) { 
          if (e.key === 'Enter') {
            showSignature(fileElement, resultElement);
          }
        });

        fileElement.addEventListener('change', function(e) {
          showSignature(fileElement, resultElement);
        });
      }

      function showSignature(fileElement, resultElement) {

        var FMT = {minimumFractionDigits: 0, maximumFractionDigits: 1};
        var r = '';
        var file;
        var reader = new FileReader();
        var fsize = '';

        if (fileElement.files === undefined ||
            fileElement.files.length === 0) {

          r = 'SELECT A FILE!';
        }
        else {
          file = fileElement.files[0];

          if (file.size > 1024) {
            fsize = T.formatNumber(file.size/1024, 'en-US', FMT) + ' KB, ';
          }
          fsize += file.size + ' byte(s)';

          r =
            getResultProperty ('File name', file.name) +
            getResultProperty ('File MIME type', file.type) +
            getResultProperty ('File size', fsize);

          reader.onload = function (e) {
            getSignatue (e.target.result, resultElement);
          };

          reader.onerror = function (e) {
            console.log ('Read error', e.type);
          }

          reader.readAsArrayBuffer (file);
        }

        resultElement.innerHTML = r;
      }

      /**
       * Processes the file bytes and appends the file description to the result element.
       * @param {*} fileData
       * @param {*} resultElement
       */
      function getSignatue(fileData, resultElement) {

        // https://wasdk.github.io/WasmFiddle/
        // move -Force C:\Users\ekond\Downloads\program.wasm D:\MyStuff\EA\eakondratiev.github.io\assets\filesignature.wasm

        const params = {
            env: {
                memory_base: 0,
                table_base: 0,
                memory : new WebAssembly.Memory({ initial: 256}),
                table: new WebAssembly.Table({
                    initial: 0,
                    element: 'anyfunc',
                })
            }          
          };

        fetch('/assets/filesignature.wasm')
          .then(response =>
            response.arrayBuffer()
          )
          .then(bytes => WebAssembly.instantiate(bytes, params))
          .then(results => {

            var instance = results.instance;

            const { memory, getFileSignature } = instance.exports;

            // create input and output arrays
            let allZeroes = a => {
              for (let i = 0; i < a.length; i++) {a[i] = 0;}
            };

            // input
            const ARRAY_SIZE = 45;
            let offset = 0;

            const fileBytes = new Uint8Array(memory.buffer, offset, ARRAY_SIZE);
            allZeroes (fileBytes);
            fileBytes.set(new Uint8Array (fileData, 0, Math.min (fileData.byteLength, ARRAY_SIZE)));

            // result
            offset += ARRAY_SIZE * Uint8Array.BYTES_PER_ELEMENT;
            const resultBytes = new Uint8Array(memory.buffer, offset, ARRAY_SIZE);
            allZeroes (resultBytes);

            var r = getFileSignature (fileBytes.byteOffset, resultBytes.byteOffset, ARRAY_SIZE);

            resultElement.innerHTML += getResultProperty ('Description', getDescription (getStringFromBuffer(resultBytes)));

            console.log ('RES', {fileBytes, resultBytes});

            
          })
          .catch(err => {
            resultElement.innerHTML += ' * ERR: ' + err.toString();
            console.log(err);
            }
          );

      }

      /**
       * Returns html formatted file property.
       * @param {string} name
       * @param {string} value
       * @param {string} unit
       */
      function getResultProperty(name, value) {

        return '<div class="file-prop">' +
            '<span class="file-prop-name">' + name + '</span>' +
            '<span class="file-prop-value">' + value + '</span>' +
            '</div>';
      }

      /**
       * Returns the string from the buffer array.
       * @param buf
       */
      function getStringFromBuffer (buf) {
        let s = "";
        let index = 0;
        while(true){
            if(buf[index] !== 0){
                s += String.fromCharCode(buf[index]);
                index++;
            }else{
                return s;
            }
        }

        return '';
      }

      /**
       * Returns the file description by the key.
       * @param {string} key
       */
      function getDescription(key) {

        if (key === '') {
          return 'signature not found';
        }

        if (SIGNATURES[key] === undefined) {
          return 'unknown file ' + key;
        }

        return SIGNATURES[key].description;
      }
    
      var SIGNATURES = {
        JPEG: {description: 'JPEG raw or in the JFIF or Exif'}
        };
    
    </script>
  </body>
</html>